<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Secure</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        
        /* Full Screen Overlay for Login */
        #login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #212529, #343a40); z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        .login-card { width: 350px; border-radius: 15px; border-top: 5px solid #0d6efd; background: white; }
        
        .nav-link { cursor: pointer; color: #495057; font-weight: 500; border-radius: 0 !important; border-bottom: 3px solid transparent !important; }
        .nav-link.active { color: #0d6efd !important; background: transparent !important; border-bottom: 3px solid #0d6efd !important; border-color: transparent transparent #0d6efd transparent !important; }
        
        .card { border: none; border-radius: 12px; }
        .dashboard-header { background: #fff; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        
        .table-hover tbody tr:hover { background-color: #f8f9fa; cursor: pointer; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="card p-4 text-center shadow-lg login-card">
        <div class="mb-4">
            <i class="fas fa-user-shield fa-3x text-primary mb-2"></i>
            <h4 class="fw-bold">Admin Portal</h4>
        </div>
        
        <div id="system-status" class="alert alert-info p-2 small mb-4 fw-bold">
            <i class="fas fa-spinner fa-spin"></i> Connecting to Secure Core...
        </div>

        <div class="input-group mb-4">
            <span class="input-group-text bg-light"><i class="fas fa-lock text-muted"></i></span>
            <input type="password" id="adminPass" class="form-control" placeholder="Enter Master Password">
        </div>
        
        <button id="loginBtn" class="btn btn-primary w-100 fw-bold py-2 shadow-sm" disabled>Login Access</button>
        <p class="text-danger mt-3 small fw-bold" id="loginMsg"></p>
    </div>
</div>

<div class="dashboard-header">
    <div class="container d-flex justify-content-between align-items-center">
        <h3 class="mb-0 fw-bold text-dark"><i class="fas fa-bus"></i> TrioTrack Command Center</h3>
        <div>
            <a href="index.html" class="btn btn-outline-secondary btn-sm me-2"><i class="fas fa-home"></i> User App</a>
            <button id="logoutBtn" class="btn btn-danger btn-sm"><i class="fas fa-sign-out-alt"></i> Lock Session</button>
        </div>
    </div>
</div>

<div class="container">
    <ul class="nav nav-tabs mb-4 border-0">
        <li class="nav-item"><a class="nav-link active" id="tab-fleet"><i class="fas fa-list"></i> Manage Fleet</a></li>
        <li class="nav-item"><a class="nav-link" id="tab-route"><i class="fas fa-route"></i> Add Route</a></li>
        <li class="nav-item"><a class="nav-link" id="tab-driver"><i class="fas fa-id-card"></i> Driver Accounts</a></li>
    </ul>

    <!-- SECTION: MANAGE FLEET -->
    <div id="fleet-section" class="tab-section">
        <div class="card p-4 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0">Active Bus Routes</h5>
                <button id="refreshFleetBtn" class="btn btn-sm btn-outline-primary"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Bus ID</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Stops Count</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="fleetTableBody">
                        <tr><td colspan="5" class="text-center text-muted">Loading fleet data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SECTION: ADD ROUTE -->
    <div id="route-section" class="tab-section d-none">
        <div class="card p-4 shadow-sm">
            <h5 class="fw-bold mb-4 border-bottom pb-2">Add New Bus Route</h5>
            <form id="routeForm">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Bus Name</label>
                        <input type="text" id="busName" class="form-control" placeholder="e.g. City Express" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Bus Number / ID</label>
                        <input type="text" id="busNumber" class="form-control" placeholder="e.g. KL-01-A-1234" required style="text-transform: uppercase;">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Category</label>
                        <select id="category" class="form-select">
                            <option>Private Bus</option>
                            <option>Public Bus (KSRTC)</option>
                            <option>Interstate</option>
                            <option>Institution</option>
                        </select>
                    </div>
                </div>
                
                <h6 class="fw-bold mt-4 mb-3 text-primary"><i class="fas fa-map-signs"></i> Route Timetable</h6>
                <div id="stops-container" class="bg-light p-3 rounded border">
                    <div class="input-group mb-2 shadow-sm">
                        <span class="input-group-text bg-success text-white border-success fw-bold">Start</span>
                        <input type="text" id="startPoint" class="form-control" placeholder="Origin Location" required>
                        <input type="time" id="startTime" class="form-control" required>
                    </div>
                    
                    <div class="input-group mb-2 shadow-sm">
                        <span class="input-group-text text-muted fw-bold">Via</span>
                        <input type="text" class="form-control stop-loc" placeholder="Intermediate Stop 1">
                        <input type="time" class="form-control stop-time">
                    </div>
                    <div class="input-group mb-2 shadow-sm">
                        <span class="input-group-text text-muted fw-bold">Via</span>
                        <input type="text" class="form-control stop-loc" placeholder="Intermediate Stop 2">
                        <input type="time" class="form-control stop-time">
                    </div>
                    
                    <div class="input-group mt-3 shadow-sm">
                        <span class="input-group-text bg-danger text-white border-danger fw-bold">End</span>
                        <input type="text" id="endPoint" class="form-control" placeholder="Final Destination" required>
                        <input type="time" id="endTime" class="form-control" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-dark w-100 mt-4 py-2 fw-bold shadow"><i class="fas fa-save"></i> Publish Route Database</button>
            </form>
        </div>
    </div>

    <!-- SECTION: DRIVER ACCOUNTS -->
    <div id="driver-section" class="tab-section d-none">
        <div class="card p-4 border-warning shadow-sm" style="border-top-width: 4px;">
            <h5 class="fw-bold mb-4">Create Driver Credentials</h5>
            <div class="alert alert-warning small"><i class="fas fa-info-circle"></i> This generates the access key a driver uses to broadcast their GPS location.</div>
            <form id="driverForm">
                <div class="mb-3">
                    <label class="form-label fw-bold">Vehicle Registration (Username)</label>
                    <input type="text" id="driverBusID" class="form-control" placeholder="e.g. KL-01" required style="text-transform: uppercase;">
                </div>
                <div class="mb-4">
                    <label class="form-label fw-bold">Secure PIN / Password</label>
                    <input type="text" id="driverPass" class="form-control" placeholder="e.g. 1234" required>
                </div>
                <button type="submit" class="btn btn-warning w-100 fw-bold py-2 shadow-sm"><i class="fas fa-key"></i> Provision Access</button>
            </form>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- FIREBASE CONFIG (UNTOUCHED) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDcWwo0m2eS1ndyC06U1G_JF1J7Y1WNlfQ",
      authDomain: "triotrack-66dd6.firebaseapp.com",
      projectId: "triotrack-66dd6",
      storageBucket: "triotrack-66dd6.firebasestorage.app",
      messagingSenderId: "994389952848",
      appId: "1:994389952848:web:659fbc330f2d660dfb0455",
      measurementId: "G-B7TMFX0F21"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ready Status
    document.getElementById('system-status').innerHTML = "<i class='fas fa-check-circle'></i> System Armed & Ready";
    document.getElementById('system-status').classList.replace('alert-info', 'alert-success');
    document.getElementById('loginBtn').disabled = false;

    // --- 1. ADMIN LOGIN CHECK ---
    const executeLogin = async () => {
        const inputPass = document.getElementById('adminPass').value.trim();
        const msg = document.getElementById('loginMsg');
        const btn = document.getElementById('loginBtn');
        if (!inputPass) return;

        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Verifying...";
        btn.disabled = true;

        try {
            const docRef = doc(db, "credentials", "admin_master");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                if (inputPass === docSnap.data().password) {
                    document.getElementById('login-overlay').style.display = 'none';
                    loadFleetData(); // Load data on successful login
                } else {
                    msg.innerHTML = "<i class='fas fa-times-circle'></i> Access Denied";
                    btn.innerText = "Login Access";
                    btn.disabled = false;
                }
            } else {
                alert("Error: 'admin_master' document missing in Database.");
                msg.innerText = "Config Error";
                btn.disabled = false;
            }
        } catch (error) {
            console.error(error);
            msg.innerText = "Network Error";
            btn.disabled = false;
        }
    };

    document.getElementById('loginBtn').addEventListener('click', executeLogin);
    document.getElementById('adminPass').addEventListener('keypress', (e) => { if(e.key === 'Enter') executeLogin(); });

    document.getElementById('logoutBtn').addEventListener('click', () => location.reload());

    // --- 2. TABS LOGIC ---
    const switchTab = (targetId) => {
        document.querySelectorAll('.tab-section').forEach(el => el.classList.add('d-none'));
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`${targetId}-section`).classList.remove('d-none');
        document.getElementById(`tab-${targetId}`).classList.add('active');
    };

    document.getElementById('tab-fleet').addEventListener('click', () => switchTab('fleet'));
    document.getElementById('tab-route').addEventListener('click', () => switchTab('route'));
    document.getElementById('tab-driver').addEventListener('click', () => switchTab('driver'));

    // --- 3. MANAGE FLEET (NEW READ/DELETE LOGIC) ---
    async function loadFleetData() {
        const tbody = document.getElementById('fleetTableBody');
        tbody.innerHTML = "<tr><td colspan='5' class='text-center'><i class='fas fa-spinner fa-spin'></i> Fetching from secure server...</td></tr>";
        
        try {
            const snapshot = await getDocs(collection(db, "routes"));
            if(snapshot.empty) {
                tbody.innerHTML = "<tr><td colspan='5' class='text-center text-muted'>No routes found in database.</td></tr>";
                return;
            }
            
            let html = "";
            snapshot.forEach(doc => {
                const data = doc.data();
                html += `
                    <tr>
                        <td class="fw-bold">${data.busNumber}</td>
                        <td>${data.busName}</td>
                        <td><span class="badge bg-secondary">${data.category}</span></td>
                        <td>${data.route ? data.route.length : 0} Stops</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${doc.id}">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;

            // Attach Delete Listeners
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    if(confirm("Are you sure you want to PERMANENTLY delete this route?")) {
                        await deleteDoc(doc(db, "routes", id));
                        loadFleetData(); // Refresh list
                    }
                });
            });

        } catch(err) {
            tbody.innerHTML = `<tr><td colspan='5' class='text-danger'>Error: ${err.message}</td></tr>`;
        }
    }
    
    document.getElementById('refreshFleetBtn').addEventListener('click', loadFleetData);

    // --- 4. CREATE DRIVER LOGIC (UNTOUCHED CORE) ---
    document.getElementById('driverForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const busID = document.getElementById('driverBusID').value.toUpperCase().trim();
        const pass = document.getElementById('driverPass').value.trim();
        
        try {
            await setDoc(doc(db, "credentials", busID), { password: pass });
            alert("Driver Account Successfully Provisioned!");
            e.target.reset();
        } catch (error) { alert("Error: " + error.message); }
    });

    // --- 5. SAVE ROUTE LOGIC (UNTOUCHED CORE) ---
    document.getElementById('routeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        let stops = [];
        
        stops.push({ name: document.getElementById('startPoint').value, time: document.getElementById('startTime').value });
        
        document.querySelectorAll('#stops-container .input-group').forEach(div => {
            if(div.querySelector('.stop-loc')) {
                const loc = div.querySelector('.stop-loc').value;
                const time = div.querySelector('.stop-time').value;
                if(loc && loc.trim() !== "") stops.push({ name: loc, time: time || "N/A" });
            }
        });
        
        stops.push({ name: document.getElementById('endPoint').value, time: document.getElementById('endTime').value });

        const busData = {
            busName: document.getElementById('busName').value,
            busNumber: document.getElementById('busNumber').value.toUpperCase(),
            category: document.getElementById('category').value,
            route: stops,
            searchKeywords: stops.map(s => s.name.toLowerCase().trim())
        };

        try {
            await addDoc(collection(db, "routes"), busData);
            alert("Route Saved to Database Successfully!");
            e.target.reset();
            loadFleetData(); // Refresh fleet view
        } catch (err) { alert("Error saving route: " + err.message); }
    });
</script>
</body>
</html>
