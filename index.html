<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <title>TrioTrack - Find, Route, Track</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Roboto:wght@300;400;500&display=swap');

        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --accent-color: #0dcaf0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3, h4, h5 {
            font-family: 'Montserrat', sans-serif;
        }

        /* SPA Sections */
        .spa-section { display: none; animation: fadeIn 0.4s ease-in-out; }
        .spa-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Welcome Screen */
        .hero-title { font-weight: 800; letter-spacing: -1px; }
        .tagline { letter-spacing: 3px; font-weight: 300; color: var(--secondary-color); font-size: 0.9rem; }
        .feature-card { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: none; }
        .feature-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        /* Map & Cards */
        #map-container { display: none; height: 600px; margin-top: 20px; border-radius: 15px; border: 2px solid var(--primary-color); position: relative; z-index: 10; background: #fff; overflow: hidden; }
        #map { height: 70%; width: 100%; }
        
        /* Real-Time Status Panel (Replaces Linear Timeline) */
        #status-panel {
            height: 30%;
            background: linear-gradient(to right, #ffffff, #f8f9fa);
            border-top: 3px solid var(--primary-color);
            padding: 15px;
            overflow-y: auto;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .status-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary-color);
        }

        .status-label { font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: bold; }
        .status-value { font-size: 1.1rem; font-weight: 700; color: #212529; }
        
        .pulse-live {
            width: 10px; height: 10px; background-color: #198754; border-radius: 50%; 
            display: inline-block; margin-right: 5px;
            animation: blink 1.5s infinite;
        }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* Recent Searches */
        .recent-search-item {
            cursor: pointer;
            transition: background 0.2s;
        }
        .recent-search-item:hover {
            background-color: rgba(13, 110, 253, 0.1) !important;
        }

        /* Dark Mode Overrides */
        [data-bs-theme="dark"] .bg-light { background-color: #121212 !important; }
        [data-bs-theme="dark"] .card { background-color: #1e1e1e; border-color: #333; }
        [data-bs-theme="dark"] #status-panel { background: #2c2c2c; border-top-color: #444; }
        [data-bs-theme="dark"] .status-item { background: #1e1e1e; color: white; }
        [data-bs-theme="dark"] .status-value { color: white; }
    </style>
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg sticky-top shadow-sm" style="background-color: var(--bs-body-bg);">
    <div class="container">
        <a class="navbar-brand d-flex flex-column" href="#" onclick="showSection('welcome-section')">
            <span class="hero-title text-primary"><i class="fas fa-bus-alt me-2"></i>TRIOTRACK</span>
            <span class="tagline">FIND • ROUTE • TRACK</span>
        </a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <div class="d-flex align-items-center gap-3 flex-column flex-lg-row mt-3 mt-lg-0">
                <div class="text-end lh-1 d-none d-lg-block">
                    <div id="clock-time" class="fw-bold">00:00:00</div>
                    <div id="clock-date" class="small text-muted">Loading...</div>
                </div>
                <!-- Admin Button in Navbar -->
                <a href="admin.html" class="btn btn-outline-danger btn-sm rounded-pill px-3">
                    <i class="fas fa-user-shield me-1"></i> Admin
                </a>
                <button class="btn btn-outline-secondary rounded-circle btn-sm" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </div>
</nav>

<div class="container py-4">

    <!-- 1. WELCOME / ABOUT SECTION -->
    <div id="welcome-section" class="spa-section active">
        <div class="row align-items-center mb-5">
            <div class="col-lg-6">
                <h1 class="display-4 fw-bold mb-3"><span class="text-primary">Live</span> Fleet Tracking</h1>
                <p class="lead text-muted mb-4">
                    Next-Gen Public Transport Intelligence. Find your bus, check the schedule, and track it live with high-precision telemetry.
                </p>
                <div class="bg-body-secondary p-4 rounded-4 mb-4">
                    <h5 class="fw-bold"><i class="fas fa-satellite-dish me-2"></i>Coverage</h5>
                    <p class="mb-0 text-muted">
                        Real-time tracking for Private Buses, KSRTC (Kerala), Interstate Coaches, and Educational Institution Fleets.
                    </p>
                </div>
                <button onclick="showSection('category-section')" class="btn btn-primary btn-lg rounded-pill px-5 shadow">
                    Find A Bus <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
            <div class="col-lg-6 text-center mt-4 mt-lg-0">
                <!-- NEW IMAGE: Bus Illustration -->
                <img src="https://cdn-icons-png.flaticon.com/512/3448/3448636.png" alt="Bus Tracking" class="img-fluid" style="max-width: 400px; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1));">
            </div>
        </div>
    </div>

    <!-- 2. CATEGORY SELECTION -->
    <div id="category-section" class="spa-section">
        <button class="btn btn-link text-decoration-none mb-3" onclick="showSection('welcome-section')"><i class="fas fa-arrow-left"></i> Back</button>
        <h3 class="fw-bold mb-4 text-center">Select Transport Type</h3>
        
        <div class="row g-4 justify-content-center">
            <!-- Private -->
            <div class="col-md-5 col-lg-3">
                <div class="card h-100 feature-card p-3 text-center" onclick="openSearch('Private Bus')">
                    <div class="card-body">
                        <div class="bg-warning bg-opacity-10 text-warning rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                            <i class="fas fa-bus fa-2x"></i>
                        </div>
                        <h5 class="card-title fw-bold">Private Bus</h5>
                        <p class="card-text small text-muted">Local & District Connections</p>
                    </div>
                </div>
            </div>
            <!-- KSRTC -->
            <div class="col-md-5 col-lg-3">
                <div class="card h-100 feature-card p-3 text-center" onclick="openSearch('Public Bus (KSRTC)')">
                    <div class="card-body">
                        <div class="bg-success bg-opacity-10 text-success rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                            <i class="fas fa-landmark fa-2x"></i>
                        </div>
                        <h5 class="card-title fw-bold">KSRTC</h5>
                        <p class="card-text small text-muted">Public Transport Kerala</p>
                    </div>
                </div>
            </div>
            <!-- Interstate -->
            <div class="col-md-5 col-lg-3">
                <div class="card h-100 feature-card p-3 text-center" onclick="openSearch('Interstate')">
                    <div class="card-body">
                        <div class="bg-danger bg-opacity-10 text-danger rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                            <i class="fas fa-road fa-2x"></i>
                        </div>
                        <h5 class="card-title fw-bold">Interstate</h5>
                        <p class="card-text small text-muted">Long Haul Connections</p>
                    </div>
                </div>
            </div>
            <!-- Institution -->
            <div class="col-md-5 col-lg-3">
                <div class="card h-100 feature-card p-3 text-center" onclick="showSection('institution-section')">
                    <div class="card-body">
                        <div class="bg-info bg-opacity-10 text-info rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                            <i class="fas fa-university fa-2x"></i>
                        </div>
                        <h5 class="card-title fw-bold">Institution</h5>
                        <p class="card-text small text-muted">College & School Fleets</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. SEARCH SECTION -->
    <div id="search-section" class="spa-section">
        <button class="btn btn-link text-decoration-none mb-3" onclick="showSection('category-section')"><i class="fas fa-arrow-left"></i> Back to Categories</button>
        
        <div class="card shadow-sm border-0 p-4 mb-4">
            <h5 class="mb-3" id="search-title">Find Bus</h5>
            <input type="hidden" id="categoryFilter">

            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <label class="small text-muted mb-1">From</label>
                    <input type="text" id="source" class="form-control" placeholder="Start Location" list="stopOptions">
                </div>
                
                <div class="col-md-1 text-center">
                    <button class="btn btn-outline-secondary rounded-circle" id="swapBtn" title="Swap Locations">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                </div>

                <div class="col-md-4">
                    <label class="small text-muted mb-1">To</label>
                    <input type="text" id="destination" class="form-control" placeholder="End Location" list="stopOptions">
                </div>
                
                <div class="col-md-2">
                    <button id="searchBtn" class="btn btn-primary w-100"><i class="fas fa-search me-1"></i> Search</button>
                </div>
            </div>
            <datalist id="stopOptions"></datalist>

            <!-- Recent Searches Section -->
            <div id="recent-searches-container" class="mt-3" style="display:none;">
                <label class="small text-muted fw-bold mb-2"><i class="fas fa-history me-1"></i> Recent Searches</label>
                <div id="recent-searches-list" class="d-flex flex-wrap gap-2"></div>
            </div>
        </div>

        <div id="map-container">
            <div class="d-flex justify-content-between p-3 bg-white border-bottom rounded-top">
                <h6 class="text-success fw-bold m-0" id="map-title"><i class="fas fa-satellite-dish me-2"></i>Live Tracking</h6>
                <button id="closeMapBtn" class="btn btn-sm btn-close"></button>
            </div>
            <div id="map"></div>
            
            <!-- NEW REAL-TIME STATUS PANEL -->
            <div id="status-panel">
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">Live Status</div>
                        <div class="status-value text-success"><span class="pulse-live"></span> <span id="live-status-text">Moving</span></div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Next Stop</div>
                        <div class="status-value" id="next-stop-display">Calculating...</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Est. Arrival</div>
                        <div class="status-value" id="eta-display">--:--</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Speed</div>
                        <div class="status-value" id="speed-display">0 km/h</div>
                    </div>
                </div>
                <div class="mt-2 text-center text-muted small" id="distance-info">
                    Waiting for location update...
                </div>
            </div>
        </div>

        <div id="results" class="mt-4"></div>
    </div>

    <!-- 4. INSTITUTION SECTION -->
    <div id="institution-section" class="spa-section">
        <!-- (Same as before) -->
        <button class="btn btn-link text-decoration-none mb-3" onclick="showSection('category-section')"><i class="fas fa-arrow-left"></i> Back</button>
        <div class="card p-4 border-0 shadow-sm">
             <h4 class="mb-4 text-info"><i class="fas fa-graduation-cap me-2"></i>Institutional Transport</h4>
             <div class="alert alert-secondary">Select your district to view Polytechnic fleets.</div>
             <!-- ... content remains ... -->
        </div>
    </div>

</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. FIREBASE CONFIG (UNCHANGED)
    const firebaseConfig = {
      apiKey: "AIzaSyDcWwo0m2eS1ndyC06U1G_JF1J7Y1WNlfQ",
      authDomain: "triotrack-66dd6.firebaseapp.com",
      projectId: "triotrack-66dd6",
      storageBucket: "triotrack-66dd6.firebasestorage.app",
      messagingSenderId: "994389952848",
      appId: "1:994389952848:web:659fbc330f2d660dfb0455",
      measurementId: "G-B7TMFX0F21"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let map = null;
    let marker = null;
    let userMarker = null;
    let unsubscribe = null;
    let allRoutesData = [];

    // Helper: Convert Time
    window.formatTime = (timeStr) => {
        if(!timeStr || timeStr === "N/A") return "";
        const [hours, minutes] = timeStr.split(':');
        const h = parseInt(hours);
        const ampm = h >= 12 ? 'PM' : 'AM';
        const h12 = h % 12 || 12;
        return `${h12}:${minutes} ${ampm}`;
    };
    
    // Calculate distance between two coords (Haversine formula)
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // UI Helpers
    window.showSection = (id) => {
        document.querySelectorAll('.spa-section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
        if(id === 'search-section') loadRecentSearches();
    };

    window.openSearch = (category) => {
        document.getElementById('categoryFilter').value = category;
        document.getElementById('search-title').innerHTML = `Find ${category}`;
        showSection('search-section');
    };

    // Dark Mode
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
        const html = document.documentElement;
        const icon = themeToggle.querySelector('i');
        if (html.getAttribute('data-bs-theme') === 'light') {
            html.setAttribute('data-bs-theme', 'dark');
            icon.classList.replace('fa-moon', 'fa-sun');
        } else {
            html.setAttribute('data-bs-theme', 'light');
            icon.classList.replace('fa-sun', 'fa-moon');
        }
    });

    // Clock
    setInterval(() => {
        const now = new Date();
        document.getElementById('clock-time').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        document.getElementById('clock-date').innerText = now.toLocaleDateString(undefined, {weekday: 'long', month: 'short', day: 'numeric'});
    }, 1000);

    // Swap Btn
    document.getElementById('swapBtn').addEventListener('click', () => {
        const src = document.getElementById('source');
        const dst = document.getElementById('destination');
        const temp = src.value;
        src.value = dst.value;
        dst.value = temp;
    });

    // Recent Searches
    function loadRecentSearches() {
        const history = JSON.parse(localStorage.getItem('trio_recent')) || [];
        const container = document.getElementById('recent-searches-container');
        const list = document.getElementById('recent-searches-list');
        list.innerHTML = "";
        if (history.length > 0) {
            container.style.display = 'block';
            history.forEach(item => {
                const btn = document.createElement('div');
                btn.className = 'badge bg-light text-dark border p-2 recent-search-item';
                btn.innerHTML = `<i class="fas fa-history text-muted me-1"></i> ${item.src} <i class="fas fa-arrow-right mx-1 text-primary"></i> ${item.dst}`;
                btn.onclick = () => {
                    document.getElementById('source').value = item.src;
                    document.getElementById('destination').value = item.dst;
                };
                list.appendChild(btn);
            });
        }
    }

    function saveRecentSearch(src, dst) {
        let history = JSON.parse(localStorage.getItem('trio_recent')) || [];
        history = history.filter(h => !(h.src === src && h.dst === dst));
        history.unshift({ src, dst });
        if (history.length > 3) history.pop();
        localStorage.setItem('trio_recent', JSON.stringify(history));
        loadRecentSearches();
    }

    // Load Data
    async function loadStops() {
        try {
            const snapshot = await getDocs(collection(db, "routes"));
            const stopsSet = new Set();
            snapshot.forEach(doc => {
                const data = doc.data();
                allRoutesData.push(data);
                if (data.route && Array.isArray(data.route)) {
                    data.route.forEach(stop => {
                        if (stop.name) stopsSet.add(stop.name.trim());
                    });
                }
            });
            const dataList = document.getElementById('stopOptions');
            stopsSet.forEach(stopName => {
                const option = document.createElement('option');
                option.value = stopName;
                dataList.appendChild(option);
            });
        } catch (error) { console.error("Error loading stops:", error); }
    }
    loadStops();

    // Search Logic
    document.getElementById('searchBtn').addEventListener('click', () => {
        const src = document.getElementById('source').value.toLowerCase().trim();
        const dst = document.getElementById('destination').value.toLowerCase().trim();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const resDiv = document.getElementById('results');
        
        if (!src || !dst) return alert("Please enter both Source and Destination");
        saveRecentSearch(document.getElementById('source').value, document.getElementById('destination').value);
        resDiv.innerHTML = "<div class='text-center mt-3'><div class='spinner-border text-primary'></div><p>Searching...</p></div>";

        let html = "";
        let count = 0;

        allRoutesData.forEach(d => {
            if (categoryFilter !== "All" && d.category !== categoryFilter) return;
            const keywords = d.searchKeywords || [];
            const sIdx = keywords.indexOf(src);
            const dIdx = keywords.indexOf(dst);

            if (sIdx !== -1 && dIdx !== -1 && sIdx < dIdx) {
                count++;
                const t1Obj = d.route.find(r => r.name.toLowerCase() === src);
                const t2Obj = d.route.find(r => r.name.toLowerCase() === dst);
                
                // Helper to calculate duration (simplified)
                const duration = "Calculated in Transit"; 

                html += `<div class="card mb-3 bus-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="fw-bold text-primary m-0">${d.busName}</h5>
                            <span class="badge bg-dark">${d.busNumber}</span>
                        </div>
                        <div class="d-flex justify-content-between text-center my-3">
                            <div><small class="text-muted d-block">Departure</small><strong class="fs-5">${formatTime(t1Obj.time)}</strong></div>
                            <div><small class="text-muted d-block">Arrival</small><strong class="fs-5">${formatTime(t2Obj.time)}</strong></div>
                        </div>
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-outline-success btn-sm flex-fill track-btn" data-bus="${d.busNumber}">
                                <i class="fas fa-map-marker-alt me-1"></i> Live Track
                            </button>
                        </div>
                    </div>
                </div>`;
            }
        });
        resDiv.innerHTML = count > 0 ? html : "<div class='alert alert-warning text-center'>No buses found.</div>";

        document.querySelectorAll('.track-btn').forEach(btn => {
            btn.addEventListener('click', (e) => track(e.target.closest('button').getAttribute('data-bus')));
        });
    });

    // 5. TRACKING LOGIC (With Hybrid Map & Real-time Status)
    function track(busNum) {
        const mapDiv = document.getElementById('map-container');
        mapDiv.style.display = 'block';
        
        const busDetails = allRoutesData.find(b => b.busNumber === busNum);
        const busName = busDetails ? busDetails.busName : "Unknown Bus";
        
        document.getElementById('map-title').innerHTML = `<i class="fas fa-satellite-dish me-2"></i>Tracking: ${busName} (${busNum})`;
        
        setTimeout(() => {
            mapDiv.scrollIntoView({ behavior: 'smooth' });
            if (!map) {
                // Standard Street
                const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' });
                
                // NEW: Hybrid Satellite (Imagery + Labels)
                const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
                const labels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}');
                const hybridLayer = L.layerGroup([satellite, labels]);

                map = L.map('map', {
                    center: [10.0, 76.0],
                    zoom: 10,
                    layers: [streetLayer]
                });

                const baseMaps = {
                    "Street Map": streetLayer,
                    "Satellite Hybrid (Roads)": hybridLayer
                };
                L.control.layers(baseMaps).addTo(map);
            }
            map.invalidateSize();
            
            // Try to get User Location for distance calc
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    if(userMarker) map.removeLayer(userMarker);
                    userMarker = L.marker([lat, lng], {icon: L.divIcon({className: 'text-primary', html: '<i class="fas fa-user-circle fa-2x"></i>'})}).addTo(map);
                });
            }
        }, 100);

        if (unsubscribe) unsubscribe();
        if (marker) map.removeLayer(marker);

        // Update Real-time Panel
        const updatePanel = (speed, busLat, busLng) => {
            document.getElementById('speed-display').innerText = `${Math.round(speed || 0)} km/h`;
            
            // Determine Next Stop Logic (Based on Time, since we don't have stop coords)
            const now = new Date();
            const currentMin = now.getHours() * 60 + now.getMinutes();
            let nextStop = null;
            
            if(busDetails && busDetails.route) {
                for(let stop of busDetails.route) {
                    const [h, m] = stop.time.split(':');
                    const stopMin = parseInt(h)*60 + parseInt(m);
                    if(stopMin > currentMin) {
                        nextStop = stop;
                        break;
                    }
                }
            }

            if(nextStop) {
                document.getElementById('next-stop-display').innerText = nextStop.name;
                document.getElementById('eta-display').innerText = formatTime(nextStop.time);
                
                // Delay Status Logic (Simulated)
                // If bus is very slow but scheduled time is close -> Delayed
                if(speed < 10 && (nextStop.time_val - currentMin < 10)) {
                     document.getElementById('live-status-text').innerHTML = "<span class='text-danger'>Delayed (Traffic)</span>";
                } else {
                     document.getElementById('live-status-text').innerHTML = "On Time";
                }
            } else {
                document.getElementById('next-stop-display').innerText = "Trip Completed";
                document.getElementById('eta-display').innerText = "--";
                document.getElementById('live-status-text').innerText = "Arrived";
            }
            
            // Distance Calculation (Bus to User)
            if (userMarker) {
                const uLL = userMarker.getLatLng();
                const dist = getDistance(uLL.lat, uLL.lng, busLat, busLng);
                document.getElementById('distance-info').innerHTML = `<b>${dist.toFixed(1)} km</b> from your current location.`;
                
                // If < 0.5km
                if(dist < 0.5) document.getElementById('live-status-text').innerText = "Arriving Near You";
            }
        };

        // Live Listener
        unsubscribe = onSnapshot(doc(db, "locations", busNum), (docSnapshot) => {
            if (docSnapshot.exists()) {
                const { lat, lng, speed } = docSnapshot.data();
                
                const popupContent = `<div class="text-center"><b>${busName}</b><br><span class="badge bg-secondary">${busNum}</span></div>`;
                
                const busIcon = L.divIcon({
                    html: '<i class="fas fa-bus fa-2x text-danger" style="text-shadow: 2px 2px 4px white;"></i>',
                    className: 'dummy-class',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                if (marker) {
                    marker.setLatLng([lat, lng]).setIcon(busIcon);
                } else { 
                    marker = L.marker([lat, lng], {icon: busIcon}).addTo(map).bindPopup(popupContent).openPopup();
                }
                map.setView([lat, lng], 15);
                updatePanel(speed, lat, lng);

            } else { 
                alert("GPS Signal Lost: This bus is offline.");
            }
        });
    }

    document.getElementById('closeMapBtn').addEventListener('click', () => {
        document.getElementById('map-container').style.display = 'none';
        if (unsubscribe) unsubscribe();
    });

</script>
</body>
</html>
