<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <title>TrioTrack - Find, Route, Track</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Roboto:wght@300;400;500&display=swap');

        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --accent-color: #0dcaf0;
            --timeline-bg: #dee2e6;
            --timeline-active: #0d6efd;
            --success-color: #198754;
        }

        body {
            font-family: 'Roboto', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3, h4, h5 {
            font-family: 'Montserrat', sans-serif;
        }

        /* SPA Sections */
        .spa-section { display: none; animation: fadeIn 0.4s ease-in-out; }
        .spa-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Welcome Page Design */
        .welcome-hero {
            padding: 50px 20px;
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.05) 0%, rgba(13, 202, 240, 0.05) 100%);
            border-radius: 40px;
            margin-bottom: 30px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .hero-bus-img {
            max-width: 450px;
            width: 100%;
            height: auto;
            filter: drop-shadow(0 20px 30px rgba(0,0,0,0.15));
            margin-bottom: 25px;
            animation: float 4s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .hero-title { font-weight: 800; font-size: 3.5rem; color: #212529; margin-bottom: 0; letter-spacing: -1px; }
        .hero-tagline { 
            letter-spacing: 6px; 
            font-weight: 700; 
            color: var(--primary-color); 
            font-size: 1.2rem; 
            margin-bottom: 30px;
            text-transform: uppercase;
        }
        .about-card {
            background: white;
            border-radius: 25px;
            padding: 35px;
            max-width: 900px;
            margin: 0 auto 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.04);
            border: 1px solid #f0f0f0;
        }
        .about-text {
            line-height: 1.8;
            color: #4a4a4a;
            font-size: 1.05rem;
            text-align: center;
            margin: 0;
        }

        /* Duration Badge */
        .duration-badge {
            background: rgba(13, 110, 253, 0.1);
            color: var(--primary-color);
            font-weight: 700;
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 5px;
        }

        /* Feature Cards */
        .feature-card { cursor: pointer; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: none; border-radius: 25px; background: white; border: 1px solid #eee; }
        .feature-card:hover { transform: translateY(-10px); box-shadow: 0 20px 30px rgba(0,0,0,0.08); border-color: var(--primary-color); }

        /* Map & Status */
        #map-container { display: none; margin-top: 20px; border-radius: 25px; border: 1px solid #eee; position: relative; z-index: 10; background: #fff; overflow: hidden; box-shadow: 0 15px 50px rgba(0,0,0,0.1); }
        #map { height: 400px; width: 100%; }
        
        /* Live Timeline */
        #status-panel { background: #fdfdfd; padding: 25px; border-top: 1px solid #eee; }
        .timeline-container { position: relative; padding-left: 20px; margin-top: 10px; }
        .timeline-line { position: absolute; left: 95px; top: 0; bottom: 0; width: 8px; background: var(--timeline-bg); border-radius: 4px; }
        .timeline-progress { position: absolute; left: 95px; top: 0; width: 8px; background: var(--success-color); border-radius: 4px; transition: height 0.8s ease-in-out; z-index: 1; }
        .timeline-stop { position: relative; display: flex; align-items: center; padding: 20px 0; }
        .stop-time-col { width: 80px; text-align: right; padding-right: 30px; font-weight: 700; color: #666; font-size: 0.9rem; }
        .stop-main-col { flex: 1; padding-left: 35px; position: relative; }
        .timeline-dot { position: absolute; left: 91px; width: 16px; height: 16px; background: #fff; border: 4px solid var(--timeline-bg); border-radius: 50%; z-index: 2; transition: all 0.3s; }
        .timeline-stop.passed .timeline-dot { border-color: var(--success-color); background: var(--success-color); }
        .timeline-stop.current .timeline-dot { border-color: var(--success-color); background: #fff; box-shadow: 0 0 0 5px rgba(25, 135, 84, 0.2); animation: pulse-dot 2s infinite; }
        @keyframes pulse-dot { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .stop-name { font-weight: 700; font-size: 1.1rem; color: #212529; }
        .stop-dist { font-size: 0.8rem; color: #888; font-weight: 500; }
        .bus-indicator { position: absolute; left: 81px; z-index: 10; transform: translateY(-50%); display: flex; align-items: center; }
        .bus-indicator-box { background: var(--success-color); color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; box-shadow: 0 4px 10px rgba(25, 135, 84, 0.3); margin-left: 20px; white-space: nowrap; }
        .pulse-live { width: 12px; height: 12px; background-color: var(--success-color); border-radius: 50%; display: inline-block; margin-right: 8px; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        [data-bs-theme="dark"] .bg-light { background-color: #0f0f0f !important; }
        [data-bs-theme="dark"] .card, [data-bs-theme="dark"] .about-card, [data-bs-theme="dark"] #status-panel, [data-bs-theme="dark"] #map-container { background-color: #1a1a1a; color: white; border-color: #2a2a2a; }
        [data-bs-theme="dark"] .about-text { color: #aaa; }
        [data-bs-theme="dark"] .stop-name { color: #eee; }
        [data-bs-theme="dark"] .timeline-line { background: #333; }
        [data-bs-theme="dark"] .hero-title { color: #fff; }
        [data-bs-theme="dark"] .duration-badge { background: rgba(13, 110, 253, 0.2); }
    </style>
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg sticky-top shadow-sm" style="background-color: var(--bs-body-bg);">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#" onclick="showSection('welcome-section')">
            <i class="fas fa-bus-alt me-2 text-primary fa-lg"></i>
            <div class="d-flex flex-column">
                <span class="fw-bold text-primary lh-1" style="letter-spacing: 1px;">TRIOTRACK</span>
                <span class="small text-muted" style="font-size: 0.65rem; letter-spacing: 2px;">FIND • ROUTE • TRACK</span>
            </div>
        </a>
        
        <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <div class="d-flex align-items-center gap-3 flex-column flex-lg-row mt-3 mt-lg-0">
                <div class="text-end lh-1 d-none d-lg-block me-3">
                    <div id="clock-time" class="fw-bold">00:00:00</div>
                    <div id="clock-date" class="small text-muted">Loading...</div>
                </div>
                <a href="admin.html" class="btn btn-danger btn-sm rounded-pill px-4 py-2 fw-bold">
                    <i class="fas fa-user-shield me-1"></i> Admin
                </a>
                <button class="btn btn-outline-secondary rounded-circle btn-sm" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </div>
</nav>

<div class="container py-4">

    <!-- 1. WELCOME SECTION -->
    <div id="welcome-section" class="spa-section active text-center">
        <div class="welcome-hero">
            <img src="https://cdn-icons-png.flaticon.com/512/3448/3448636.png" alt="Bus Tracking Illustration" class="hero-bus-img">
            <h1 class="hero-title">TRIOTRACK</h1>
            <p class="hero-tagline">Find - Route - Track</p>
        </div>
            
        <div class="about-card">
            <div class="about-text">
                The main aim of TrioTrack is to develop a smart and user-friendly web-based tracking system that allows users to find locations, view routes, and track live positions in real time. The project focuses on creating a simple and efficient platform that improves navigation, enhances location monitoring, and provides accurate tracking through an interactive map interface. TrioTrack is designed to demonstrate practical implementation of web technologies while solving real-world problems related to location tracking and route management.
            </div>
        </div>

        <button onclick="showSection('category-section')" class="btn btn-primary btn-lg rounded-pill px-5 py-3 shadow-lg fw-bold transition-transform">
            GET STARTED <i class="fas fa-chevron-right ms-2"></i>
        </button>
    </div>

    <!-- 2. CATEGORY SELECTION -->
    <div id="category-section" class="spa-section">
        <button class="btn btn-link text-decoration-none mb-3 text-dark fw-bold" onclick="showSection('welcome-section')"><i class="fas fa-arrow-left"></i> Back</button>
        <h3 class="fw-bold mb-4 text-center">Select Transport Type</h3>
        
        <div class="row g-4 justify-content-center">
            <div class="col-md-5 col-lg-3">
                <div class="card h-100 feature-card p-4 text-center" onclick="openSearch('Private Bus')">
                    <div class="bg-warning bg-opacity-10 text-warning rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                        <i class="fas fa-bus fa-2x"></i>
                    </div>
                    <h5 class="fw-bold">Private Bus</h5>
                    <p class="small text-muted mb-0">Local & Inter-city</p>
                </div>
            </div>
            <div class="col-md-5 col-lg-3">
                <div class="card h-100 feature-card p-4 text-center" onclick="openSearch('Public Bus (KSRTC)')">
                    <div class="bg-success bg-opacity-10 text-success rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                        <i class="fas fa-landmark fa-2x"></i>
                    </div>
                    <h5 class="fw-bold">KSRTC</h5>
                    <p class="small text-muted mb-0">State Fleet Kerala</p>
                </div>
            </div>
            <div class="col-md-5 col-lg-3">
                <div class="card h-100 feature-card p-4 text-center" onclick="openSearch('Interstate')">
                    <div class="bg-danger bg-opacity-10 text-danger rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                        <i class="fas fa-road fa-2x"></i>
                    </div>
                    <h5 class="fw-bold">Interstate</h5>
                    <p class="small text-muted mb-0">Across Borders</p>
                </div>
            </div>
            <div class="col-md-5 col-lg-3">
                <div class="card h-100 feature-card p-4 text-center" onclick="showSection('institution-section')">
                    <div class="bg-info bg-opacity-10 text-info rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                        <i class="fas fa-university fa-2x"></i>
                    </div>
                    <h5 class="fw-bold">Institution</h5>
                    <p class="small text-muted mb-0">College/School Buses</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. SEARCH SECTION -->
    <div id="search-section" class="spa-section">
        <button class="btn btn-link text-decoration-none mb-3 text-dark fw-bold" onclick="showSection('category-section')"><i class="fas fa-arrow-left"></i> Back to Categories</button>
        
        <div class="card shadow-sm border-0 p-4 mb-4 rounded-4">
            <h5 class="fw-bold mb-3" id="search-title">Search Route</h5>
            <input type="hidden" id="categoryFilter">

            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label class="small text-muted mb-1 fw-bold">SOURCE</label>
                    <input type="text" id="source" class="form-control form-control-lg bg-light border-0" placeholder="Where from?" list="stopOptions">
                </div>
                
                <div class="col-md-1 text-center">
                    <button class="btn btn-white shadow-sm rounded-circle border" id="swapBtn">
                        <i class="fas fa-exchange-alt text-primary"></i>
                    </button>
                </div>

                <div class="col-md-4">
                    <label class="small text-muted mb-1 fw-bold">DESTINATION</label>
                    <input type="text" id="destination" class="form-control form-control-lg bg-light border-0" placeholder="Where to?" list="stopOptions">
                </div>
                
                <div class="col-md-2">
                    <button id="searchBtn" class="btn btn-primary btn-lg w-100 fw-bold rounded-3">FIND BUS</button>
                </div>
            </div>
            <datalist id="stopOptions"></datalist>

            <div id="recent-searches-container" class="mt-3" style="display:none;">
                <label class="small text-muted fw-bold mb-2"><i class="fas fa-history me-1"></i> RECENT SEARCHES</label>
                <div id="recent-searches-list" class="d-flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- TRACKING CONTAINER -->
        <div id="map-container">
            <div class="d-flex justify-content-between align-items-center p-3 bg-white border-bottom">
                <div>
                    <h6 class="text-primary fw-bold m-0" id="map-title">Live Tracking</h6>
                    <small class="text-muted"><i class="fas fa-sync fa-spin me-1"></i> Live telemetry active</small>
                </div>
                <button id="closeMapBtn" class="btn btn-light rounded-circle"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="map"></div>
            
            <div id="status-panel">
                <div class="row mb-4">
                    <div class="col-6">
                        <div class="badge bg-success bg-opacity-10 text-success p-2 px-3 rounded-pill">
                            <span class="pulse-live"></span> <span id="live-status-text">Broadcasting</span>
                        </div>
                    </div>
                    <div class="col-6 text-end">
                        <small class="text-muted d-block fw-bold">SPEED</small>
                        <strong id="speed-display" class="fs-4 text-primary">0</strong> <small>km/h</small>
                    </div>
                </div>

                <!-- VERTICAL TIMELINE -->
                <div class="timeline-container" id="live-timeline">
                    <div class="timeline-line"></div>
                    <div class="timeline-progress" id="timeline-progress-bar"></div>
                    <div id="timeline-stops-list">
                        <!-- Stops injected here -->
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-light rounded-4 text-center small text-muted border" id="distance-info">
                    Waiting for GPS lock...
                </div>
            </div>
        </div>

        <div id="results" class="mt-4"></div>
    </div>

    <!-- 4. INSTITUTION SECTION -->
    <div id="institution-section" class="spa-section">
        <button class="btn btn-link text-decoration-none mb-3 text-dark fw-bold" onclick="showSection('category-section')"><i class="fas fa-arrow-left"></i> Back</button>
        <div class="card p-5 border-0 shadow-sm rounded-5 text-center bg-white">
             <div class="mb-4">
                 <i class="fas fa-map-marked-alt fa-4x text-info opacity-50"></i>
             </div>
             <h4 class="fw-bold text-dark">Institutional Fleet Tracking</h4>
             <p class="text-muted mx-auto" style="max-width: 500px;">We are currently integrating GPS gateways for Colleges and Schools. This feature will be available shortly.</p>
             <button class="btn btn-outline-info rounded-pill px-4 mt-2" onclick="showSection('category-section')">Browse Available Fleets</button>
        </div>
    </div>

</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // DO NOT CHANGE FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyDcWwo0m2eS1ndyC06U1G_JF1J7Y1WNlfQ",
      authDomain: "triotrack-66dd6.firebaseapp.com",
      projectId: "triotrack-66dd6",
      storageBucket: "triotrack-66dd6.firebasestorage.app",
      messagingSenderId: "994389952848",
      appId: "1:994389952848:web:659fbc330f2d660dfb0455",
      measurementId: "G-B7TMFX0F21"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let map = null;
    let marker = null;
    let userMarker = null;
    let unsubscribe = null;
    let allRoutesData = [];

    // Helper: Format Time
    window.formatTime = (timeStr) => {
        if(!timeStr || timeStr === "N/A") return "N/A";
        const [hours, minutes] = timeStr.split(':');
        const h = parseInt(hours);
        const ampm = h >= 12 ? 'PM' : 'AM';
        const h12 = h % 12 || 12;
        return `${h12}:${minutes} ${ampm}`;
    };

    // Helper: Calculate Duration
    window.calculateDuration = (startTime, endTime) => {
        if (!startTime || !endTime || startTime === "N/A" || endTime === "N/A") return "N/A";
        const [h1, m1] = startTime.split(':').map(Number);
        const [h2, m2] = endTime.split(':').map(Number);
        let diff = (h2 * 60 + m2) - (h1 * 60 + m1);
        if (diff < 0) diff += 1440; // If crosses midnight
        const h = Math.floor(diff / 60);
        const m = diff % 60;
        return h > 0 ? `${h}h ${m}m` : `${m}m`;
    };

    // Share Functionality
    window.shareBus = (name, number) => {
        const text = `I'm tracking ${name} (${number}) live on TrioTrack! Check it out:`;
        const url = window.location.href;
        
        if (navigator.share) {
            navigator.share({ title: 'TrioTrack Live', text: text, url: url })
            .catch(err => console.log('Error sharing', err));
        } else {
            const dummy = document.createElement('input');
            document.body.appendChild(dummy);
            dummy.value = `${text} ${url}`;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
            alert("Tracking details copied to clipboard!");
        }
    };

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    window.showSection = (id) => {
        document.querySelectorAll('.spa-section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
        if(id === 'search-section') loadRecentSearches();
    };

    window.openSearch = (category) => {
        document.getElementById('categoryFilter').value = category;
        document.getElementById('search-title').innerHTML = `<i class="fas fa-search me-2"></i> ${category} Search`;
        showSection('search-section');
    };

    // Dark Mode Toggle
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
        const html = document.documentElement;
        const icon = themeToggle.querySelector('i');
        if (html.getAttribute('data-bs-theme') === 'light') {
            html.setAttribute('data-bs-theme', 'dark');
            icon.classList.replace('fa-moon', 'fa-sun');
        } else {
            html.setAttribute('data-bs-theme', 'light');
            icon.classList.replace('fa-sun', 'fa-moon');
        }
    });

    // Real-time Clock
    setInterval(() => {
        const now = new Date();
        document.getElementById('clock-time').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        document.getElementById('clock-date').innerText = now.toLocaleDateString(undefined, {weekday: 'long', month: 'short', day: 'numeric'});
    }, 1000);

    // Swap Inputs
    document.getElementById('swapBtn').addEventListener('click', () => {
        const src = document.getElementById('source');
        const dst = document.getElementById('destination');
        [src.value, dst.value] = [dst.value, src.value];
    });

    function loadRecentSearches() {
        const history = JSON.parse(localStorage.getItem('trio_recent')) || [];
        const container = document.getElementById('recent-searches-container');
        const list = document.getElementById('recent-searches-list');
        list.innerHTML = "";
        if (history.length > 0) {
            container.style.display = 'block';
            history.forEach(item => {
                const badge = document.createElement('div');
                badge.className = 'badge bg-white text-dark border p-2 recent-search-item shadow-sm fw-normal';
                badge.innerHTML = `<i class="fas fa-clock text-muted me-1"></i> ${item.src} → ${item.dst}`;
                badge.onclick = () => {
                    document.getElementById('source').value = item.src;
                    document.getElementById('destination').value = item.dst;
                };
                list.appendChild(badge);
            });
        }
    }

    async function loadStops() {
        const snapshot = await getDocs(collection(db, "routes"));
        const stopsSet = new Set();
        snapshot.forEach(doc => {
            const data = doc.data();
            allRoutesData.push(data);
            if (data.route) data.route.forEach(stop => stopsSet.add(stop.name.trim()));
        });
        const dataList = document.getElementById('stopOptions');
        stopsSet.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            dataList.appendChild(opt);
        });
    }
    loadStops();

    document.getElementById('searchBtn').addEventListener('click', () => {
        const src = document.getElementById('source').value.toLowerCase().trim();
        const dst = document.getElementById('destination').value.toLowerCase().trim();
        const cat = document.getElementById('categoryFilter').value;
        const resDiv = document.getElementById('results');
        
        if (!src || !dst) return;
        
        let history = JSON.parse(localStorage.getItem('trio_recent')) || [];
        history = history.filter(h => !(h.src === src && h.dst === dst));
        history.unshift({ src: document.getElementById('source').value, dst: document.getElementById('destination').value });
        localStorage.setItem('trio_recent', JSON.stringify(history.slice(0, 5)));

        resDiv.innerHTML = "<div class='text-center py-5'><div class='spinner-border text-primary'></div></div>";

        let html = "";
        let count = 0;

        allRoutesData.forEach(d => {
            if (cat !== "All" && d.category !== cat) return;
            const keys = d.searchKeywords || [];
            const sIdx = keys.indexOf(src);
            const dIdx = keys.indexOf(dst);

            if (sIdx !== -1 && dIdx !== -1 && sIdx < dIdx) {
                count++;
                const stopA = d.route.find(r => r.name.toLowerCase() === src);
                const stopB = d.route.find(r => r.name.toLowerCase() === dst);
                const duration = calculateDuration(stopA.time, stopB.time);

                html += `
                <div class="card mb-3 border-0 shadow-sm rounded-4 overflow-hidden">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-4">
                            <div>
                                <h5 class="fw-bold text-primary mb-1">${d.busName}</h5>
                                <span class="badge bg-light text-dark border px-2 py-1">${d.busNumber}</span>
                            </div>
                            <button class="btn btn-outline-primary btn-sm rounded-pill px-3 fw-bold" onclick="shareBus('${d.busName}', '${d.busNumber}')">
                                <i class="fas fa-share-alt me-1"></i> Share
                            </button>
                        </div>
                        <div class="row text-center mb-4">
                            <div class="col-5 text-start ps-4">
                                <small class="text-muted d-block text-uppercase fw-bold mb-1">DEPARTURE</small>
                                <strong class="fs-4">${formatTime(stopA.time)}</strong>
                            </div>
                            <div class="col-2 d-flex flex-column align-items-center justify-content-center">
                                <i class="fas fa-chevron-right text-muted fa-lg"></i>
                                <span class="duration-badge">${duration}</span>
                            </div>
                            <div class="col-5 text-end pe-4">
                                <small class="text-muted d-block text-uppercase fw-bold mb-1">ARRIVAL</small>
                                <strong class="fs-4">${formatTime(stopB.time)}</strong>
                            </div>
                        </div>
                        <button class="btn btn-success btn-lg w-100 rounded-pill fw-bold track-btn" data-bus="${d.busNumber}">
                            <i class="fas fa-map-marker-alt me-1"></i> START LIVE TRACKING
                        </button>
                    </div>
                </div>`;
            }
        });
        resDiv.innerHTML = count > 0 ? html : "<div class='alert alert-light text-center border-dashed py-4 rounded-4'>No matching routes found. Try a different source or destination.</div>";

        document.querySelectorAll('.track-btn').forEach(btn => {
            btn.addEventListener('click', (e) => track(e.target.closest('button').getAttribute('data-bus')));
        });
    });

    function track(busNum) {
        const mapDiv = document.getElementById('map-container');
        mapDiv.style.display = 'block';
        const busDetails = allRoutesData.find(b => b.busNumber === busNum);
        document.getElementById('map-title').innerHTML = `<i class="fas fa-satellite-dish me-2"></i>Tracking: ${busDetails.busName}`;
        
        setTimeout(() => {
            mapDiv.scrollIntoView({ behavior: 'smooth' });
            if (!map) {
                map = L.map('map').setView([10.8505, 76.2711], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
            map.invalidateSize();
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    if(userMarker) map.removeLayer(userMarker);
                    userMarker = L.circleMarker([latitude, longitude], { color: '#0d6efd', radius: 8, fillOpacity: 0.8 }).addTo(map).bindPopup("Your Location");
                });
            }
        }, 100);

        if (unsubscribe) unsubscribe();
        if (marker) map.removeLayer(marker);

        const timelineList = document.getElementById('timeline-stops-list');
        timelineList.innerHTML = "";
        busDetails.route.forEach((stop, index) => {
            const stopEl = document.createElement('div');
            stopEl.className = 'timeline-stop';
            stopEl.id = `stop-${index}`;
            stopEl.innerHTML = `
                <div class="stop-time-col">${formatTime(stop.time)}</div>
                <div class="timeline-dot"></div>
                <div class="stop-main-col">
                    <div class="stop-name">${stop.name}</div>
                    <div class="stop-dist">Scheduled Stop</div>
                </div>
            `;
            timelineList.appendChild(stopEl);
        });

        unsubscribe = onSnapshot(doc(db, "locations", busNum), (snap) => {
            if (snap.exists()) {
                const { lat, lng, speed } = snap.data();
                document.getElementById('speed-display').innerText = Math.round(speed || 0);
                
                const busIcon = L.divIcon({
                    html: `<i class="fas fa-bus-alt fa-2x text-danger" style="text-shadow: 0 0 10px white;"></i>`,
                    className: 'dummy', iconSize: [30, 30], iconAnchor: [15, 15]
                });

                if (marker) marker.setLatLng([lat, lng]);
                else marker = L.marker([lat, lng], {icon: busIcon}).addTo(map);
                map.setView([lat, lng], 14);

                updateTimelineProgress(busDetails.route);

                if(userMarker) {
                    const dist = getDistance(userMarker.getLatLng().lat, userMarker.getLatLng().lng, lat, lng);
                    document.getElementById('distance-info').innerHTML = `The bus is <b>${dist.toFixed(1)} km</b> away from your current location.`;
                }
            } else {
                alert("GPS link lost. This fleet might be currently stationary or in a low-signal area.");
            }
        });
    }

    function updateTimelineProgress(route) {
        const now = new Date();
        const currentMins = now.getHours() * 60 + now.getMinutes();
        let activeIndex = -1;

        route.forEach((stop, i) => {
            const [h, m] = stop.time.split(':');
            const stopMins = parseInt(h) * 60 + parseInt(m);
            const el = document.getElementById(`stop-${i}`);
            
            if (stopMins < currentMins) {
                el.classList.add('passed');
                el.classList.remove('current');
                activeIndex = i;
            } else if (activeIndex === i - 1) {
                el.classList.add('current');
                el.classList.remove('passed');
                
                const existing = document.querySelector('.bus-indicator');
                if(existing) existing.remove();
                
                const indicator = document.createElement('div');
                indicator.className = 'bus-indicator';
                indicator.innerHTML = `
                    <div class="bus-indicator-box"><i class="fas fa-bus me-1"></i> BUS HERE</div>
                `;
                el.appendChild(indicator);
            } else {
                el.classList.remove('passed', 'current');
            }
        });

        if (activeIndex !== -1) {
            const total = route.length;
            const percent = ((activeIndex + 0.5) / (total - 1)) * 100;
            document.getElementById('timeline-progress-bar').style.height = `${Math.min(percent, 100)}%`;
        }
    }

    document.getElementById('closeMapBtn').addEventListener('click', () => {
        document.getElementById('map-container').style.display = 'none';
        if (unsubscribe) unsubscribe();
    });

</script>
</body>
</html>
