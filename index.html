<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Find My Bus - User Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0d6efd;
            --bg-light: #f8f9fa;
            --text-light: #212529;
            --card-light: #ffffff;
            --bg-dark: #121212;
            --text-dark: #e0e0e0;
            --card-dark: #1e1e1e;
        }
        body { transition: background-color 0.3s, color 0.3s; background-color: var(--bg-light); color: var(--text-light); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body.dark-mode { background-color: var(--bg-dark); color: var(--text-dark); }
        
        .card { border: none; border-radius: 15px; background-color: var(--card-light); transition: 0.3s; }
        body.dark-mode .card { background-color: var(--card-dark); border: 1px solid #333; }
        body.dark-mode .form-control { background-color: #2d2d2d; color: #fff; border-color: #444; }
        body.dark-mode .list-group-item { background-color: var(--card-dark); color: var(--text-dark); border-color: #333; }
        
        /* Navbar & Top Bar */
        .top-bar { background: linear-gradient(90deg, #0d6efd, #0dcaf0); color: white; padding: 5px 15px; font-size: 0.85rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .navbar { background-color: var(--card-light); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        body.dark-mode .navbar { background-color: var(--card-dark); border-bottom: 1px solid #333; }
        
        /* SPA Sections */
        .page-section { display: none; animation: fadeIn 0.4s ease-in-out; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Typography */
        .brand-title { font-size: 2.5rem; font-weight: 900; letter-spacing: 2px; background: linear-gradient(90deg, #0d6efd, #0dcaf0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .brand-subtitle { font-size: 1rem; font-weight: 700; letter-spacing: 4px; color: #6c757d; }
        
        /* Category Cards */
        .category-card { cursor: pointer; transition: 0.3s; border-bottom: 4px solid transparent; height: 100%; }
        .category-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .cat-private { border-bottom-color: #ffc107; }
        .cat-transport { border-bottom-color: #198754; }
        .cat-interstate { border-bottom-color: #dc3545; }
        .cat-institution { border-bottom-color: #6f42c1; }

        /* Map */
        #map-container { display: none; height: 450px; border-radius: 15px; overflow: hidden; border: 3px solid #198754; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #map { height: 100%; width: 100%; }
        
        .bus-card { border-left: 5px solid #0d6efd; }
        .recent-pill { cursor: pointer; border-radius: 20px; font-size: 0.85rem; padding: 5px 15px; background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; display: inline-block; margin: 3px; transition: 0.2s; }
        .recent-pill:hover { background-color: #0d6efd; color: white; }
        body.dark-mode .recent-pill { background-color: rgba(13, 110, 253, 0.2); color: #6ea8fe; }
        
        .swap-btn { border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #e9ecef; border: none; transition: 0.3s; }
        .swap-btn:hover { background: #ced4da; transform: rotate(180deg); }
        body.dark-mode .swap-btn { background: #333; color: white; }
    </style>
</head>
<body>

<!-- TOP BAR -->
<div class="top-bar">
    <div id="live-time"><i class="far fa-clock"></i> Loading time...</div>
    <div>
        <button id="themeToggleBtn" class="btn btn-sm btn-link text-white text-decoration-none"><i class="fas fa-moon"></i> Theme</button>
        <a href="admin.html" class="btn btn-sm btn-light ms-2 fw-bold text-primary"><i class="fas fa-user-shield"></i> Admin Portal</a>
    </div>
</div>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg py-3 sticky-top">
    <div class="container">
        <span class="navbar-brand fw-bold d-flex align-items-center gap-2" onclick="window.navigateTo('page-welcome')" style="cursor: pointer;">
            <i class="fas fa-bus text-primary fs-3"></i> 
            <span class="body.dark-mode ? 'text-white' : 'text-dark'">TrioTrack</span>
        </span>
        <button class="btn btn-outline-secondary d-none" id="backBtn" onclick="window.goBack()"><i class="fas fa-arrow-left"></i> Back</button>
    </div>
</nav>

<div class="container my-4">

    <!-- PAGE 1: WELCOME -->
    <div id="page-welcome" class="page-section active text-center">
        <div class="py-5">
            <h1 class="brand-title">TRIOTRACK</h1>
            <p class="brand-subtitle">FIND â€¢ ROUTE â€¢ TRACK</p>
            
            <div class="row justify-content-center mt-5">
                <div class="col-md-8">
                    <div class="card p-4 shadow-sm text-start border-0 bg-opacity-10" style="background-color: rgba(13, 110, 253, 0.05);">
                        <h4 class="fw-bold mb-3 text-primary"><i class="fas fa-info-circle"></i> About TrioTrack</h4>
                        <p style="line-height: 1.8;">
                            TrioTrack is an advanced, real-time bus availability and tracking platform designed to streamline your daily commute. 
                            Whether you are navigating rural landscapes, utilizing district-wide public transit, or embarking on interstate journeys, 
                            TrioTrack helps you find active routes instantly. By providing live GPS tracking and precise scheduling, we eliminate the guesswork from public transportation, ensuring you reach your destination efficiently and on time.
                        </p>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary btn-lg mt-5 px-5 rounded-pill shadow" onclick="window.navigateTo('page-sections')">
                Explore Routes <i class="fas fa-arrow-right ms-2"></i>
            </button>
        </div>
    </div>

    <!-- PAGE 2: SECTIONS -->
    <div id="page-sections" class="page-section">
        <div class="text-center mb-5">
            <h2 class="fw-bold">Select Service Category</h2>
            <p class="text-muted">Choose the type of fleet you are looking for</p>
        </div>

        <div class="row g-4 justify-content-center">
            <div class="col-md-5 col-lg-3">
                <div class="card category-card cat-private p-4 text-center shadow-sm" onclick="window.selectCategory('Private Bus')">
                    <i class="fas fa-shuttle-van fa-3x text-warning mb-3"></i>
                    <h5 class="fw-bold">Private</h5>
                    <p class="small text-muted mb-0">Rural Area Connections</p>
                </div>
            </div>
            <div class="col-md-5 col-lg-3">
                <div class="card category-card cat-transport p-4 text-center shadow-sm" onclick="window.selectCategory('Public Bus (KSRTC)')">
                    <i class="fas fa-bus-alt fa-3x text-success mb-3"></i>
                    <h5 class="fw-bold">Transport</h5>
                    <p class="small text-muted mb-0">Govt / District Connections</p>
                </div>
            </div>
            <div class="col-md-5 col-lg-3">
                <div class="card category-card cat-interstate p-4 text-center shadow-sm" onclick="window.selectCategory('Interstate')">
                    <i class="fas fa-map-marked-alt fa-3x text-danger mb-3"></i>
                    <h5 class="fw-bold">Interstate</h5>
                    <p class="small text-muted mb-0">Major Cities Connections</p>
                </div>
            </div>
            <div class="col-md-5 col-lg-3">
                <div class="card category-card cat-institution p-4 text-center shadow-sm" onclick="window.selectCategory('Institution')">
                    <i class="fas fa-university fa-3x text-purple mb-3" style="color:#6f42c1;"></i>
                    <h5 class="fw-bold">Institution</h5>
                    <p class="small text-muted mb-0">Educational Purposes</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE 3: ROUTE FINDER -->
    <div id="page-search" class="page-section">
        <div class="card p-4 shadow-sm mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold mb-0">Find a Bus</h4>
                <span id="selectedCategoryBadge" class="badge bg-primary fs-6">All Types</span>
            </div>
            
            <div class="row g-3 align-items-center position-relative">
                <div class="col-md-5">
                    <label class="form-label small fw-bold text-muted"><i class="fas fa-map-marker-alt text-danger"></i> From</label>
                    <input type="text" id="source" class="form-control form-control-lg shadow-none" placeholder="Starting Point..." list="stopOptions">
                </div>
                
                <div class="col-md-2 text-center d-flex justify-content-center align-items-end mb-1">
                    <button class="swap-btn shadow-sm" id="swapBtn" title="Swap Source and Destination">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                </div>
                
                <div class="col-md-5">
                    <label class="form-label small fw-bold text-muted"><i class="fas fa-location-arrow text-success"></i> To</label>
                    <input type="text" id="destination" class="form-control form-control-lg shadow-none" placeholder="Destination..." list="stopOptions">
                </div>
                
                <div class="col-12 mt-4 text-center">
                    <button id="searchBtn" class="btn btn-dark btn-lg px-5 w-100 shadow"><i class="fas fa-search"></i> Search Route</button>
                </div>
            </div>
            <datalist id="stopOptions"></datalist>

            <div class="mt-4" id="recentSearchesContainer" style="display: none;">
                <span class="small text-muted fw-bold me-2">Recent:</span>
                <span id="recentList"></span>
            </div>
        </div>

        <!-- RESULTS / MAP -->
        <div id="map-container" class="mb-4">
            <div class="d-flex justify-content-between align-items-center p-3 bg-dark text-white">
                <h5 class="fw-bold mb-0" id="map-title"><i class="fas fa-satellite-dish text-success pulse"></i> Live Tracking</h5>
                <button id="closeMapBtn" class="btn btn-sm btn-danger"><i class="fas fa-times"></i> Close Map</button>
            </div>
            <div id="map"></div>
        </div>

        <div id="results"></div>
    </div>

</div>

<footer class="text-center mt-5 py-4 text-muted small border-top">
    <p class="mb-1">Â© 2024 TrioTrack Systems</p>
    <a href="driver.html" class="text-decoration-none text-secondary"><i class="fas fa-steering-wheel"></i> Driver Portal</a>
</footer>

<!-- SCRIPTS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- FIREBASE CONFIG (UNTOUCHED) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDcWwo0m2eS1ndyC06U1G_JF1J7Y1WNlfQ",
      authDomain: "triotrack-66dd6.firebaseapp.com",
      projectId: "triotrack-66dd6",
      storageBucket: "triotrack-66dd6.firebasestorage.app",
      messagingSenderId: "994389952848",
      appId: "1:994389952848:web:659fbc330f2d660dfb0455",
      measurementId: "G-B7TMFX0F21"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let map = null;
    let marker = null;
    let unsubscribe = null;
    let allRoutesData = []; 
    let currentCategoryFilter = "All";
    let historyStack = ['page-welcome'];

    // --- UI LOGIC ---
    
    // Time Bar
    setInterval(() => {
        const now = new Date();
        document.getElementById('live-time').innerHTML = `<i class="far fa-clock"></i> ${now.toLocaleDateString()} | ${now.toLocaleTimeString('en-US', { hour12: true })}`;
    }, 1000);

    // Theme Toggle
    document.getElementById('themeToggleBtn').addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('themeToggleBtn').innerHTML = isDark ? '<i class="fas fa-sun"></i> Light' : '<i class="fas fa-moon"></i> Dark';
    });

    // SPA Navigation Hooks (Attached to window for HTML access)
    window.navigateTo = (pageId) => {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        if(pageId !== 'page-welcome') {
            document.getElementById('backBtn').classList.remove('d-none');
        } else {
            document.getElementById('backBtn').classList.add('d-none');
        }
        
        if(historyStack[historyStack.length-1] !== pageId) historyStack.push(pageId);
        window.scrollTo(0, 0);
    };

    window.goBack = () => {
        if(historyStack.length > 1) {
            historyStack.pop(); // Remove current
            const prevPage = historyStack.pop(); // Get previous
            window.navigateTo(prevPage);
        }
    };

    window.selectCategory = (category) => {
        currentCategoryFilter = category;
        document.getElementById('selectedCategoryBadge').innerText = category;
        window.navigateTo('page-search');
    };

    // Swap feature
    document.getElementById('swapBtn').addEventListener('click', () => {
        const src = document.getElementById('source');
        const dst = document.getElementById('destination');
        let temp = src.value;
        src.value = dst.value;
        dst.value = temp;
    });

    // Enter Key Support
    document.getElementById('source').addEventListener('keypress', e => { if(e.key === 'Enter') document.getElementById('searchBtn').click(); });
    document.getElementById('destination').addEventListener('keypress', e => { if(e.key === 'Enter') document.getElementById('searchBtn').click(); });

    // Recent Searches Logic
    function loadRecentSearches() {
        let recents = JSON.parse(localStorage.getItem('triotrack_recent') || '[]');
        const container = document.getElementById('recentSearchesContainer');
        const list = document.getElementById('recentList');
        
        if(recents.length > 0) {
            container.style.display = 'block';
            list.innerHTML = recents.map(r => `<span class="recent-pill" onclick="window.applySearch('${r.s}', '${r.d}')">${r.s} â†’ ${r.d}</span>`).join('');
        }
    }
    
    function saveRecentSearch(s, d) {
        if(!s || !d) return;
        let recents = JSON.parse(localStorage.getItem('triotrack_recent') || '[]');
        const entry = {s, d};
        // Avoid exact duplicates
        recents = recents.filter(r => !(r.s === s && r.d === d));
        recents.unshift(entry);
        if(recents.length > 5) recents.pop();
        localStorage.setItem('triotrack_recent', JSON.stringify(recents));
        loadRecentSearches();
    }

    window.applySearch = (s, d) => {
        document.getElementById('source').value = s;
        document.getElementById('destination').value = d;
        document.getElementById('searchBtn').click();
    };
    loadRecentSearches();

    // Share feature
    window.shareBus = async (busName, busNum, time) => {
        const shareData = {
            title: 'TrioTrack Route',
            text: `Catch the ${busName} (${busNum}) at ${time}! Track it live on TrioTrack.`,
            url: window.location.href
        };
        try {
            if (navigator.share) await navigator.share(shareData);
            else {
                navigator.clipboard.writeText(shareData.text);
                alert("Bus details copied to clipboard!");
            }
        } catch (err) { console.error('Error sharing:', err); }
    };

    // --- FIREBASE LOGIC ---

    // 1. Fetch Stops
    async function loadStops() {
        try {
            const snapshot = await getDocs(collection(db, "routes"));
            const stopsSet = new Set(); 
            
            snapshot.forEach(doc => {
                const data = doc.data();
                allRoutesData.push(data); 
                if (data.route && Array.isArray(data.route)) {
                    data.route.forEach(stop => {
                        if (stop.name) stopsSet.add(stop.name.trim());
                    });
                }
            });

            const dataList = document.getElementById('stopOptions');
            stopsSet.forEach(stopName => {
                const option = document.createElement('option');
                option.value = stopName;
                dataList.appendChild(option);
            });
        } catch (error) { console.error("Error loading stops:", error); }
    }
    loadStops();

    // 2. Search Logic
    document.getElementById('searchBtn').addEventListener('click', () => {
        const src = document.getElementById('source').value.toLowerCase().trim();
        const dst = document.getElementById('destination').value.toLowerCase().trim();
        const resDiv = document.getElementById('results');
        
        if (!src || !dst) return alert("Please enter both Source and Destination");
        
        saveRecentSearch(document.getElementById('source').value, document.getElementById('destination').value);
        resDiv.innerHTML = "<div class='text-center mt-4'><div class='spinner-border text-primary'></div><p class='mt-2'>Searching routes...</p></div>";

        let html = "";
        let count = 0;

        allRoutesData.forEach(d => {
            if (currentCategoryFilter !== "All" && currentCategoryFilter !== "Institution") {
                if (d.category !== currentCategoryFilter) return; 
            }

            const keywords = d.searchKeywords || [];
            const sIdx = keywords.indexOf(src);
            const dIdx = keywords.indexOf(dst);

            if (sIdx !== -1 && dIdx !== -1 && sIdx < dIdx) {
                count++;
                const t1Obj = d.route.find(r => r.name.toLowerCase() === src);
                const t2Obj = d.route.find(r => r.name.toLowerCase() === dst);
                const t1 = t1Obj ? t1Obj.time : "N/A";
                const t2 = t2Obj ? t2Obj.time : "N/A";

                html += `
                    <div class="card mb-3 bus-card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="fw-bold text-primary mb-0"><i class="fas fa-bus"></i> ${d.busName} <small class="text-muted">(${d.busNumber})</small></h5>
                                <span class="badge bg-secondary">${d.category}</span>
                            </div>
                            <hr class="text-muted opacity-25">
                            <div class="row align-items-center text-center">
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block"><i class="fas fa-map-marker-alt text-danger"></i> Departs</small>
                                    <strong>${t1}</strong><br>
                                    <small>${t1Obj.name}</small>
                                </div>
                                <div class="col-4 border-end">
                                    <i class="fas fa-arrow-right text-muted"></i>
                                    <small class="d-block mt-1 text-muted">Duration: ~${calculateDuration(t1, t2)}</small>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block"><i class="fas fa-map-pin text-success"></i> Arrives</small>
                                    <strong>${t2}</strong><br>
                                    <small>${t2Obj.name}</small>
                                </div>
                            </div>
                            <div class="mt-3 pt-2 d-flex justify-content-between">
                                <button class="btn btn-outline-dark btn-sm" onclick="window.shareBus('${d.busName}', '${d.busNumber}', '${t1}')"><i class="fas fa-share-alt"></i> Share</button>
                                <button class="btn btn-success btn-sm fw-bold track-btn shadow-sm" data-bus="${d.busNumber}"><i class="fas fa-satellite-dish"></i> Track Live</button>
                            </div>
                        </div>
                    </div>`;
            }
        });

        resDiv.innerHTML = count > 0 ? html : "<div class='alert alert-warning text-center shadow-sm'><i class='fas fa-exclamation-circle'></i> No buses found for this route and category.</div>";

        document.querySelectorAll('.track-btn').forEach(btn => {
            btn.addEventListener('click', (e) => track(e.target.getAttribute('data-bus')));
        });
    });

    // Helper: Dummy duration calculator
    function calculateDuration(t1, t2) {
        if(t1==="N/A" || t2==="N/A") return "--";
        // Simple string parsing just for visual effect if valid format
        return "ETA"; 
    }

    // 3. Tracking Logic (Leaflet + Firebase)
    function track(busNum) {
        const mapDiv = document.getElementById('map-container');
        mapDiv.style.display = 'block';
        document.getElementById('map-title').innerHTML = `<i class="fas fa-satellite-dish text-success pulse"></i> Tracking: ${busNum}`;
        mapDiv.scrollIntoView({ behavior: 'smooth' });

        if (!map) {
            map = L.map('map').setView([10.0, 76.0], 10);
            
            // Multiple Layers
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' });
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community' });
            
            streetLayer.addTo(map); // Default
            
            const baseMaps = { "Street View": streetLayer, "Satellite View": satelliteLayer };
            L.control.layers(baseMaps).addTo(map);
        }
        
        setTimeout(() => map.invalidateSize(), 300);

        if (unsubscribe) unsubscribe();
        if (marker) map.removeLayer(marker);

        // Custom Bus Icon
        const busIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#198754; color:white; padding:5px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px rgba(0,0,0,0.5); text-align:center;'><i class='fas fa-bus'></i></div>",
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        unsubscribe = onSnapshot(doc(db, "locations", busNum), (docSnapshot) => {
            if (docSnapshot.exists()) {
                const { lat, lng } = docSnapshot.data();
                if (marker) {
                    marker.setLatLng([lat, lng]);
                } else {
                    marker = L.marker([lat, lng], {icon: busIcon}).addTo(map).bindPopup(`<b>ðŸšŒ Bus ${busNum}</b><br>Live Location`).openPopup();
                }
                map.setView([lat, lng], 15);
            } else { 
                alert("GPS Signal Lost: This bus is currently offline or not broadcasting its location.");
            }
        });
    }

    // Close Map
    document.getElementById('closeMapBtn').addEventListener('click', () => {
        document.getElementById('map-container').style.display = 'none';
        if (unsubscribe) unsubscribe();
    });

</script>
</body>
</html>
